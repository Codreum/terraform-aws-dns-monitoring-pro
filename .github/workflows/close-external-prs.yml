name: Close external PRs

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:

permissions: read-all

jobs:
  close:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: Close fork PRs (allowlisted bots)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // 1) Never close INTERNAL PRs (same repo). Only collaborators can create these.
            if (pr.head.repo.full_name === pr.base.repo.full_name) {
              core.info(`Internal PR from same repo (${pr.head.repo.full_name}). Skip.`);
              return;
            }

            // 2) Allowlisted bots (optional)
            const allowBots = new Set([
              "dependabot[bot]",
              "renovate[bot]",
              "github-actions[bot]"
            ]);
            if (allowBots.has(pr.user.login)) {
              core.info(`Allowlisted bot PR (${pr.user.login}). Skip.`);
              return;
            }

            // 3) Close external PRs (forks)
            const msg =
              "Thanks for the contribution. This repository is **read-only public**.\n\n" +
              "- Public PRs are not accepted and will be closed automatically.\n" +
              "- Codreum members: please open a branch in this repo and submit a PR from that branch.\n\n" +
              "If you need subscription/license access, use the support link in the issue forms.";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: msg
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              state: "closed"
            });
