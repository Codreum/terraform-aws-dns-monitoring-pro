name: close external PRs

on:
  pull_request_target:
    types: [opened, reopened]
  workflow_dispatch:

permissions:
  pull-requests: write
  issues: write

jobs:
  close:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Close non-member PRs (allowlisted bots)
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const pr = context.payload.pull_request;
            const assoc = pr.author_association;
            const login = pr.user?.login || "";

            // Allow org members/collaborators + *your* automation bots
            const allowedAssoc = new Set(["MEMBER","OWNER","COLLABORATOR"]);
            const allowedLogins = new Set(["dependabot[bot]","renovate[bot]"]);

            if (allowedAssoc.has(assoc) || allowedLogins.has(login)) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: [
                "Thanks for the PR! ðŸ‘‹",
                "",
                "**Important:** This repository is **public read-only**. PRs from non-Codreum accounts are not accepted and will be closed automatically.",
                "",
                "Please use:",
                "- Issues (docs/bug reports), or",
                "- SECURITY.md for security reports, or",
                "- README â†’ Pricing/Support for subscription & module access."
              ].join("\n")
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              state: "closed"
            });
